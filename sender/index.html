<html data-cast-api-enabled="true">

<head>
  <title>chromecast-nes</title>
</head>
<link rel="stylesheet" type="text/css" href="css/style.css">

<body>
  <div class='center-column-flex'>
    <section>
      <h1>Choose casting device</h1>
      <div style="width: 44px; height: 44px;">
        <google-cast-launcher></google-cast-launcher>
      </div>
    </section>
  </div>
</body>
<script src="js/jquery-1.4.2.min.js"></script>
<script src="js/dynamicaudio-min.js"></script>
<script src="js/jsnes.js"></script>
<script src="js/peerjs.min.js"></script>

<script>
  const applicationId = 'F1F2B4A5';
  const namespace = 'urn:x-cast:se.patrikkarlsson.cast.snes-cast';
  const USE_WEBRTC = true;

  let castPeerId;
  let castMediaConnection;
  let myPeer;
  let localStream;

  let castContext;
  let currentSession;

  let jsnes;
  let ui;
  
  $(function () {
    console.log('initializing peer');
    myPeer = new Peer();
    myPeer.on('open', onOpen);
    myPeer.on('call', onCall);
    myPeer.on('close', onClose);
    myPeer.on('disconnected', onDisconnected);
    myPeer.on('error', onError);
    myPeer.connect();

    jsnes = new JSNES({
      'swfPath': '/swf/',
      'ui': $('.nes').text('').JSNESUI({
        "Working": [
          ['Sir Ababol', 'roms/ababol.nes']
        ],
      }),
    });

    ui = jsnes.ui;
    document.body.appendChild(ui.root[0]);
  });

  window['__onGCastApiAvailable'] = function (isAvailable) {
    if (isAvailable) {
      initializeCastApi();
    }
  };

  const initializeCastApi = function () {
    castContext = cast.framework.CastContext.getInstance();
    cast.framework.setLoggerLevel(cast.framework.LoggerLevel.DEBUG);
    castContext.setOptions({
      receiverApplicationId: applicationId,
      autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
    });
    castContext.addEventListener(cast.framework.CastContextEventType.CAST_STATE_CHANGED, onCastStateChanged);
    castContext.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED, onSessionStateChanged);
  };

  const onCastStateChanged = (event) => {
    console.log(event.data);
  };

  const onSessionStateChanged = (event) => {
    console.log(event);
    if (event.sessionState === cast.framework.SessionState.SESSION_STARTED && event.session) {
      console.log('started');
      currentSession = event.session;
      currentSession.addMessageListener(namespace, onCustomMessage);
      launch();
    } else if (event.sessionState === cast.framework.SessionState.SESSION_START_FAILED) {
      console.log('failed to start session :(');
    } else if (event.sessionState === cast.framework.SessionState.SESSION_ENDED) {
      cleanup();
    }
  };

  const onCustomMessage = (recievedNameSpace, message) => {
    if (recievedNameSpace !== namespace) {
      console.error('unexpected namespace');
      return;
    }
    let parsedMessage = JSON.parse(message);
    console.log('Recieved message: ' + parsedMessage);

    if (parsedMessage.type == 'castPeerId') {
        setCastPeerId(parsedMessage.peerId);
    } else {
      console.log('unhandled custom message');
      console.log(message);
    }
  };

  const getCastPeerId = () => {
    if (currentSession) {
      currentSession.sendMessage(namespace, { type: 'sendPeerId' }); 
    }
  };

  const setCastPeerId = (id) => {
    castPeerId = id;
    if (castPeerId && !castMediaConnection && localStream) {
      castMediaConnection = myPeer.call(castPeerId, localStream);
      // TODO: set event handlers
    }
  }

  const launch = function () {
    if (currentSession) {
      console.log("running");

      // jsnes.loadRom();
      //jsnes.start();
      var canvas = $(".nes-screen")[0]; // TODO: offscreen rendering
      localStream = canvas.captureStream();
      getCastPeerId();

      // var json = { "type": "writeFrame", "frame": canvas.toDataURL() };
      // console.log('sending image');
      // currentSession.sendMessage(namespace, json);
    } else if (jsnes) {
      cleanup();
    }
  };

  const onCall = (mediaConn) => {
    console.error("called, we shouldn't be called..");
  };

  const onOpen = (id) => {
    console.log('Connected to Peer-server with id: ' + id);
  };

  const onClose = () => {
    console.log('Closed');
    cleanup();
    myPeer.destroy();
  };

  const onDisconnected = () => {
    console.log('disconnected');
    if (!castPeerId) {
      myPeer.reconnect();
    }
  };

  const onError = error => {
    console.log(error);
  };

  const cleanup = () => {
    console.log('Cleaning up');
    castPeerId = null;
    jsnes.stop();
    if (currentSession) {
      currentSession.removeMessageListener(namespace, onCustomMessage);
    }
  };
</script>
<script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

</html>